<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="shortcut icon" href="/static/img/favicon.ico" /><title>Node.js + Express Generator - Structured Software Jargon</title><meta name="author" content="Dave McNavish" /><meta name="description" content="Node.js + Express Generator" /><meta name="keywords" content="Node.js + Express Generator, Structured Software Jargon, " /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="Structured Software Jargon" property="og:site_name"><meta content="Node.js + Express Generator" property="og:title"><meta content="article" property="og:type"><meta content="My Personal Stack Problems" property="og:description"><meta content="http://localhost:4000/2017/08/26/Nodejs-server.html" property="og:url"><meta content="2017-08-26T00:00:00-07:00" property="article:published_time"><meta content="http://localhost:4000/about/" property="article:author"><meta content="http://localhost:4000https://avatars1.githubusercontent.com/u/3458331?v=4&s=400" property="og:image"><meta content="nodejs" property="article:tag"><meta content="express" property="article:tag"><meta content="sequelize" property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@"><meta name="twitter:title" content="Node.js + Express Generator"><meta name="twitter:url" content="http://localhost:4000/2017/08/26/Nodejs-server.html"><meta name="twitter:description" content="My Personal Stack Problems"><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="/static/css/syntax.css"><link href="/static/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/css/super-search.css"><link rel="stylesheet" href="/static/css/thickbox.css"><link rel="stylesheet" href="/static/css/projects.css"><link rel="stylesheet" href="/static/css/main.css"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-104147520-1', 'auto'); ga('send', 'pageview'); </script><body><div class="container"><div class="col-sm-3"><div class="fixed-condition"> <a href="/"><img class="profile-avatar" src="https://avatars1.githubusercontent.com/u/3458331?v=4&s=400" height="75px" width="75px" /></a><h1 class="author-name">Dave McNavish</h1><div class="profile-about"> I am a software developer that loves to learn and share my knowledge with like minded folks.</div><div class="social"><ul><li><a href="https://www.linkedin.com/in/david-mcnavish-8a004722/" target="_blank"><i class="fa fa-linkedin"></i></a><li><a href="https://stackoverflow.com/users/947240/dmcnavish" target="_blank"><i class="fa fa-stack-overflow"></i></a><li><a href="https://github.com/dmcnavish" target="_blank"><i class="fa fa-github"></i></a></ul></div><div class="search" id="js-search"> <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input"><ul class="search__results" id="js-search__results"></ul></div><hr /><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="/">Home</a><li><a class="about" href="/about/">About Me</a><li><a class="about" href="/feed.xml">RSS</a><li><a class="about" href="/tags">Tags</a></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><header class="post-header"><h1 class="post-title">Node.js + Express Generator</h1></header><span class="time">26 Aug 2017</span> <span class="categories"> &raquo; </span><div class="content"><div class="post"><p>At work, I don’t start brand new projects very often. At most of the jobs I have had, either the projects have already been established and tasks involve adding new features to it, or code bases are inherited from other companies/groups. Usually looking at someone else’s project for the first time is accompanied with phrases such as “Why would anyone do it this way?” or “If I was building this type of application I would have done it in [x] language and with [y] framework.”<p>Side projects on the other hand usually only consist of starting from scratch. This is both exhilarating and exhausting. At least for me, the process usually goes as follows: Read about a new language/framework, decide to build something using that technology, then spend most of my Saturday setting up my developer environment, and finally barely get through a hello world app before my free time runs out. I’m sure that I’m not the only person with this workflow, and it shows by the number of new languages/frameworks that have some sort of generator/scaffolding tool that greatly speeds up the process.<p>Recently I was trying to build a web app using React and needed a server that would serve the API and would also allow uploading files. I decided to use a Node.js server, but instantly had flash backs about the last time I attempted to use <a href="https://expressjs.com/">Express</a> from scratch and how I had spent most of my time trying to figure out which packages to include and which order to add them to my app.js file so that the server would start up and do what I needed. This time however, it went a lot smoother. Now, Express has an <a href="https://expressjs.com/en/starter/generator.html">express-generotor</a> which scaffolds out the project for you and includes all of the needed dependencies to get you off the ground and running in no time.<p>Let’s give it a try.<div class="highlighter-rouge"><pre class="highlight"><code>$npm install express-generator -g
$express myapp
$cd myapp
$npm i
$npm start
</code></pre></div><p>Done. The project is built, installed, and running. If you go to the browser and navigate to localhost:3000, you will be greeted by a very basic page that says “Express” and a warm feeling in your stomach because you don’t have to spend the next 2 hours dealing with missing/mismatched dependencies.<p>Now that you have the basics of the project built for you, it is time to decide how you want your project structured. You can always change you mind later, but it is a lot easier to decide now when you have only a few classes and components, than later when you have way more and way less time to change things around.<p>After doing a lot of searching, blog reading, blog skimming, and sifting through StackOverflow answers, I found that I really like <a href="https://stackoverflow.com/a/19623507/947240">this</a> structure which is demonstrated in <a href="https://github.com/focusaurus/express_code_structure">this Github repo</a>. There is a lot going on there. I would recommend you taking a few minutes to read through it all.<p>The main idea that I am looking for is where to put the router and model files for each component. I have worked on projects that have separated them into their own folders with all modals in one folder and all routers in another, but I like it better when everything is together in a single folder. It makes it easy to look at it and see what each component has, and what it is related to.<p>If you look at the project that the express-generator generated for us, you will notice that it has created a router folder. Instead of using that, create a new folder under the root directory named app, and then create another folder under that named users. This is where all of the user files will live. Feel free to create a folder for any other components that you will need. The component names should match what each endpoint your API will be serving; users, customers, vehicles, unicorns, etc. Once you have created the necessary folders, move the routes/users.js file into the new users folder and rename it to router.js.<p>Currently, the app is serving <a href="http://jade-lang.com/">jade</a> files to the browser. For now, I am only going to be focusing on using this application as for API endpoints. Go ahead and delete the routes folder since we won’t be needing that either.<p>The app.js file is the main entry point for all the incoming requests. If you handled all of the routes here, the file would get out of hand faster than you can say, “spaghetti junction.” To remedy this, we will only reference each components route file in the app.js.<p>In app.js, change:<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./routes/users'</span><span class="p">);</span>
</code></pre></div><p>to:<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./users/router'</span><span class="p">);</span>
</code></pre></div><p>You will notice in app.js that there is already an entry to route the requests of /users to the correct users route.<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/users'</span><span class="p">,</span> <span class="nx">users</span><span class="p">);</span>
</code></pre></div><p>To see the changes, you will need to stop the node server and then restart it. You will need to do that after every change which will get very annoying very quickly. Instead, you can use something like <a href="https://github.com/remy/nodemon">nodemon</a>, <a href="https://github.com/foreverjs/forever">forever</a>, or <a href="http://pm2.keymetrics.io/">pm2</a> to watch the project for changes and restart the server so that you can focus on making code changes and not getting angry when your changes aren’t showing up because you forgot to restart the server. If you look in our package.json under scripts, you will notice that start is mapped to “node ./bin/www” so if you are going to use nodemon, you will need to start it with:<div class="highlighter-rouge"><pre class="highlight"><code>nodemon ./bin/www
</code></pre></div><p>After the server is back up and running, you should be able to curl localhost:3000/users and get less than stellar response. When was the last time you wanted an API endpoint to return static text? Instead, you usually will want to retrieve records from a database. There are a slew of database drivers that you can use with node. Today, I’ve chosen to use <a href="http://docs.sequelizejs.com/">Sequalizejs</a>. It is fairly easy to use, it has plenty of documentation to help you along your way, and it works with a few different databases. Currently I have MySQL running locally, so I am going to use that. To install:<div class="highlighter-rouge"><pre class="highlight"><code>npm install --save sequelize
npm install --save mysql2
</code></pre></div><p>Create a file named users-model.js in app/users. In this file, we are going to create the database connection, define the model, and add a function to save and get a list of users from the database.<p>Add the following to users-model.js:<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'sequelize'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="s1">'mytestapp'</span><span class="p">,</span> <span class="s1">'app_user'</span><span class="p">,</span> <span class="s1">'supersecretpassword'</span><span class="p">,</span> <span class="p">{</span><span class="na">host</span><span class="p">:</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="na">dialect</span><span class="p">:</span> <span class="s1">'mysql'</span><span class="p">,</span> <span class="na">logging</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

<span class="kr">const</span> <span class="nx">Users</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span>
<span class="p">});</span>

<span class="nx">sequelize</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Connection has been establised to database'</span><span class="p">);</span>
<span class="nx">Users</span><span class="p">.</span><span class="nx">sync</span><span class="p">();</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'Error connecting to database'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">upsert</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Users</span>
        <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">where</span><span class="p">:</span> <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">firstName</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">lastName</span><span class="p">}})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">obj</span><span class="p">.</span><span class="nx">changed</span><span class="p">(</span><span class="s1">'updatedAt'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">user</span><span class="p">.</span><span class="nx">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Users</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">findAll</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Users</span>
        <span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">users</span><span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">users</span><span class="p">);</span>
<span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">upsert</span> <span class="o">=</span> <span class="nx">upsert</span><span class="p">;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">findAll</span> <span class="o">=</span> <span class="nx">findAll</span><span class="p">;</span>
</code></pre></div><p>Let’s walk through what is going on here. First we are create an instance of sequelize and give it the credentials to connect to our database. As your app grows and you have more components, you will want to move this out of the user specific model and into an app wide class that each model can access. For now though, this is fine. Next we define the Users model. By default, when the app starts up, it will connect to the database, and sequelize will check to see if there is a Users table with the columns firstName and lastName, if there isn’t it will create on for us. This is nice because you don’t have to worry about the code being out of sync, but you will need to put more thought into it later after you have been inserting data into the table for months and then you need to add/alter a column.<p>Next we have two functions, upsert(user) and findAll(options, callback). Upsert is used to either insert a new record or update an existing record if one already exists. This helps prevent duplicate records from getting created.<p>The findAll function takes in search parameters to give to sequalize to built the query. To get a full list of the options, read over the <a href="http://docs.sequelizejs.com/manual/tutorial/models-usage.html#data-retrieval-finders">sequalize docs</a>.<p>Back in app/users/router.js, remove the useless default ‘/’ function and replace it with the following, more meaningful code:<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">firstName</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">firstName</span><span class="p">,</span>
      <span class="na">lastName</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">lastName</span>
    <span class="p">};</span>
    <span class="nx">users</span><span class="p">.</span><span class="nx">upsert</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Failed create user'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getAll</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">users</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">users</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Failed to get users'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nx">create</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nx">getAll</span><span class="p">);</span>
</code></pre></div><p>These functions map the base routes to either create or getAll depending on the request method. Once all of the code is in place and saved, give it a try.<p>Insert a couple of users:<div class="highlighter-rouge"><pre class="highlight"><code>$curl -X POST -d '{"firstName":"dave", "lastName": "mcnavish"}' -H "Content-Type: application/json" localhost:3000/users
$curl -X POST -d '{"firstName":"bruce", "lastName": "wayne"}' -H "Content-Type: application/json" localhost:3000/users
</code></pre></div><p>Then retrieve the users:<div class="highlighter-rouge"><pre class="highlight"><code>$curl localhost:3000/users
</code></pre></div><p>There you have it. Using the express generator, we quickly created a node.js project that serves our Users API. It isn’t too magical now, but we have laid the ground work for future development. We learned how to route requests, structure a project, connect to a database, and save and retrieve records from that same database. Pat yourself on the back, you have a working API.</div><div class="share-page"> <span style="float: left;">Share this on &rarr;&nbsp;&nbsp;</span> <a href="https://twitter.com/share" class="twitter-share-button" data-via="">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script><div class="g-plus" data-action="share" data-annotation="bubble"></div><script src="https://apis.google.com/js/platform.js" async defer></script><div class="fb-share-button" data-href="http://localhost:4000/2017/08/26/Nodejs-server.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div></div><div id="fb-root"></div><script>(function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId="; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk'));</script></div><div class="PageNavigation"> <a class="prev" href="/2017/08/12/Effective-Engineer-Book-Review.html">&laquo; Effective Engineer Book Review</a> <a class="next" href="/2017/09/09/Frontend-Automation.html">Front-End Automation Testing &raquo;</a></div><div class="disqus-comments"><div id="disqus_thread"></div><script type="text/javascript"> /* <![CDATA[ */ var disqus_shortname = "dmcnavish"; var disqus_identifier = "http://localhost:4000_Node.js + Express Generator"; var disqus_title = "Node.js + Express Generator"; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); /* ]]> */ </script></div><footer> &copy; Dave McNavish - <a href="https://github.com/dmcnavish">https://github.com/dmcnavish</a> - Powered by Jekyll.</footer></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="/static/js/bootstrap.min.js"></script> <script src="/static/js/super-search.js"></script> <script src="/static/js/thickbox-compressed.js"></script> <script src="/static/js/projects.js"></script>
